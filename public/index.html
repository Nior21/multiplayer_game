<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Arial', sans-serif;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #uiOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .ui-element {
            pointer-events: auto;
            position: absolute;
        }

        /* Player info - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–ª–æ–∫ */
        #playerInfo {
            top: 1vh;
            right: 1vw;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(20, 20, 20, 0.9) 100%);
            color: white;
            padding: 0.8vh 1vw;
            border-radius: 1.5vh;
            border: 0.3vh solid rgba(255, 215, 0, 0.7);
            font-size: max(1.2vh, 12px);
            text-align: center;
            min-width: 20vw;
            max-width: 30vw;
            box-shadow: 0 0.4vh 1vh rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
        }

        .player-stats {
            display: flex;
            justify-content: space-between;
            margin: 0.5vh 0;
        }

        #nicknameDisplay {
            color: gold;
            font-weight: bold;
            font-size: max(1.4vh, 14px);
            margin-bottom: 0.5vh;
            text-shadow: 0 0 0.5vh gold;
        }

        .nickname-edit {
            display: flex;
            gap: 0.5vw;
            margin-top: 0.5vh;
        }

        #nicknameInput {
            flex: 1;
            padding: 0.3vh 0.5vw;
            background: rgba(255, 255, 255, 0.9);
            border: 0.2vh solid gold;
            border-radius: 0.5vh;
            font-size: max(1.1vh, 11px);
            min-width: 0;
        }

        #renameBtn {
            padding: 0.3vh 1vw;
            background: gold;
            border: none;
            border-radius: 0.5vh;
            font-weight: bold;
            font-size: max(1.1vh, 11px);
            white-space: nowrap;
        }

        /* Joystick - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π */
        #joystickContainer {
            bottom: max(10vh, 80px);
            left: max(2vw, 20px);
            width: min(25vh, 200px);
            height: min(25vh, 200px);
            z-index: 50;
        }

        .joystick-btn {
            position: absolute;
            width: min(8vh, 60px);
            height: min(8vh, 60px);
            background: radial-gradient(circle, rgba(255, 255, 255, 0.95) 0%, rgba(230, 230, 230, 0.9) 100%);
            border: min(0.4vh, 3px) solid gold;
            border-radius: min(2vh, 15px);
            font-size: min(4vh, 30px);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            box-shadow: 0 min(0.5vh, 4px) min(1vh, 8px) rgba(0, 0, 0, 0.3);
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
        }

        .joystick-btn:active {
            background: radial-gradient(circle, rgba(255, 215, 0, 0.95) 0%, rgba(255, 200, 0, 0.9) 100%);
            transform: scale(0.95);
        }

        #btnUp {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        #btnLeft {
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        #btnDown {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #btnRight {
            top: 50%;
            right: 0;
            transform: translateY(-50%);
        }

        /* Spells - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
        #spellsContainer {
            top: 15vh;
            right: max(1vw, 10px);
            width: min(12vh, 90px);
            height: min(60vh, 400px);
            display: flex;
            flex-direction: column;
            gap: min(1vh, 8px);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: min(0.5vw, 5px);
            z-index: 50;
        }

        /* –°–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
        #spellsContainer::-webkit-scrollbar {
            width: min(0.5vw, 4px);
        }

        #spellsContainer::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 1vh;
        }

        #spellsContainer::-webkit-scrollbar-thumb {
            background: gold;
            border-radius: 1vh;
        }

        .spell-slot {
            width: min(12vh, 90px);
            height: min(12vh, 90px);
            min-height: min(12vh, 90px);
            flex-shrink: 0;
            background: radial-gradient(circle, rgba(0, 0, 0, 0.8) 0%, rgba(30, 30, 30, 0.9) 100%);
            border: min(0.3vh, 2px) solid #666;
            border-radius: min(1.5vh, 12px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: min(1.8vh, 14px);
            position: relative;
            box-shadow: 0 min(0.4vh, 3px) min(0.8vh, 6px) rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: all 0.2s;
        }

        .spell-slot.selected {
            border-color: gold;
            border-width: min(0.5vh, 4px);
            box-shadow: 0 0 min(2vh, 15px) gold;
        }

        .spell-slot.empty {
            font-size: min(4vh, 30px);
            color: #888;
            background: rgba(0, 0, 0, 0.5);
        }

        .spell-icon {
            font-size: min(3.5vh, 26px);
            margin-bottom: min(0.5vh, 4px);
        }

        .spell-stats {
            font-size: min(1.5vh, 12px);
            color: #aaa;
        }

        /* Cast button */
        #castBtnContainer {
            bottom: max(10vh, 80px);
            right: max(2vw, 20px);
            width: min(15vh, 120px);
            height: min(15vh, 120px);
            z-index: 50;
        }

        #castButton {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #ff4444 0%, #cc0000 100%);
            border: min(0.5vh, 4px) solid #ff9900;
            border-radius: 50%;
            color: white;
            font-size: min(2.5vh, 20px);
            font-weight: bold;
            box-shadow: 0 min(0.8vh, 6px) min(1.6vh, 12px) rgba(0, 0, 0, 0.5);
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
        }

        #castButton:active {
            transform: scale(0.95);
            box-shadow: 0 min(0.4vh, 3px) min(0.8vh, 6px) rgba(0, 0, 0, 0.5);
        }

        /* Spell config modal */
        #spellConfig {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 30, 0.98) 100%);
            border: min(0.4vh, 3px) solid gold;
            border-radius: min(2vh, 15px);
            padding: min(3vh, 20px);
            color: white;
            width: min(90vw, 400px);
            max-width: 400px;
            display: none;
            z-index: 1000;
            box-shadow: 0 min(1vh, 8px) min(2vh, 16px) rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }

        #spellConfig h3 {
            margin-bottom: min(2vh, 15px);
            text-align: center;
            font-size: min(2.2vh, 18px);
            color: gold;
            text-shadow: 0 0 min(1vh, 8px) gold;
        }

        .config-btn {
            padding: min(1vh, 8px) min(2vw, 15px);
            margin: min(0.5vh, 4px);
            background: linear-gradient(to bottom, gold 0%, #ffcc00 100%);
            border: none;
            border-radius: min(1vh, 8px);
            font-weight: bold;
            font-size: min(1.5vh, 12px);
            cursor: pointer;
            transition: all 0.2s;
        }

        .config-btn:active {
            transform: scale(0.95);
        }

        .config-slider {
            width: 100%;
            margin: min(2vh, 15px) 0;
            height: min(1.5vh, 12px);
            -webkit-appearance: none;
            background: #333;
            border-radius: min(0.5vh, 4px);
        }

        .config-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: min(3vh, 24px);
            height: min(3vh, 24px);
            background: gold;
            border-radius: 50%;
            cursor: pointer;
        }

        .config-value {
            text-align: center;
            margin: min(1.5vh, 12px) 0;
            font-size: min(1.8vh, 14px);
        }

        .btn-row {
            display: flex;
            justify-content: space-between;
            margin-top: min(2vh, 15px);
            flex-wrap: wrap;
            gap: min(1vh, 8px);
        }

        .btn-row button {
            flex: 1;
            min-width: max-content;
        }

        /* Mobile controls hint */
        #controlsHint {
            position: absolute;
            bottom: max(1vh, 10px);
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: max(1vh, 10px);
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: max(0.5vh, 5px) max(1vw, 10px);
            border-radius: max(1vh, 10px);
            pointer-events: none;
            z-index: 40;
        }

        /* Loading screen */
        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10000;
        }

        .spinner {
            width: min(10vh, 50px);
            height: min(10vh, 50px);
            border: min(0.5vh, 4px) solid #333;
            border-top: min(0.5vh, 4px) solid gold;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: min(2vh, 20px);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div>Loading game...</div>
    </div>

    <div id="gameContainer" style="display: none;">
        <canvas id="canvas"></canvas>
        <div id="uiOverlay">

            <!-- Player info -->
            <div id="playerInfo" class="ui-element">
                <div id="nicknameDisplay"></div>
                <div class="player-stats">
                    <span>Score: <span id="scoreDisplay">0</span></span>
                    <span>HP: <span id="hpDisplay">100</span></span>
                </div>
                <div class="nickname-edit">
                    <input id="nicknameInput" placeholder="Name" maxlength="12">
                    <button id="renameBtn" onclick="rename()">‚úèÔ∏è</button>
                </div>
            </div>

            <!-- Joystick -->
            <div id="joystickContainer" class="ui-element">
                <div class="joystick-btn" id="btnUp">‚Üë</div>
                <div class="joystick-btn" id="btnLeft">‚Üê</div>
                <div class="joystick-btn" id="btnDown">‚Üì</div>
                <div class="joystick-btn" id="btnRight">‚Üí</div>
            </div>

            <!-- Spells -->
            <div id="spellsContainer" class="ui-element">
                <!-- –°–ª–æ—Ç—ã –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <!-- Cast button -->
            <div id="castBtnContainer" class="ui-element">
                <button id="castButton">CAST</button>
            </div>

            <!-- Controls hint -->
            <div id="controlsHint" class="ui-element">
                WASD / Arrows to move ‚Ä¢ SPACE to cast
            </div>

            <!-- Spell config modal -->
            <div id="spellConfig" class="ui-element">
                <h3>Configure Spell</h3>
                <div id="spellTypeDisplay"></div>
                <div class="config-value">
                    Speed: <span id="configSpeed">5</span> / Power: <span id="configPower">5</span>
                </div>
                <input type="range" min="1" max="10" value="5" class="config-slider" id="spellConfigSlider">
                <div class="btn-row">
                    <button class="config-btn" onclick="saveSpellConfig()">Save</button>
                    <button class="config-btn" onclick="deleteSpellConfig()">Delete</button>
                    <button class="config-btn" onclick="closeSpellConfig()">Cancel</button>
                </div>
            </div>

        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let myId = '';
        let field = [];
        let FIELD_SIZE = 15;
        let TILE_SIZE = 40;
        let players = {};
        let spells = [];
        let currentConfigIndex = -1;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let longPressTimer = null;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const loadingScreen = document.getElementById('loadingScreen');
        const gameContainer = document.getElementById('gameContainer');
        const nicknameDisplay = document.getElementById('nicknameDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const hpDisplay = document.getElementById('hpDisplay');
        const nicknameInput = document.getElementById('nicknameInput');
        const spellConfig = document.getElementById('spellConfig');
        const configSlider = document.getElementById('spellConfigSlider');
        const configSpeed = document.getElementById('configSpeed');
        const configPower = document.getElementById('configPower');
        const spellTypeDisplay = document.getElementById('spellTypeDisplay');
        const socket = io();

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å UI
        function updateUISizes() {
            const vh = window.innerHeight * 0.01;
            const vw = window.innerWidth * 0.01;

            // –û–±–Ω–æ–≤–ª—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∏—Ö
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            document.documentElement.style.setProperty('--vw', `${vw}px`);

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞
            resizeCanvas();

            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            adaptUIForScreen();
        }

        function resizeCanvas() {
            const container = gameContainer;
            const width = container.clientWidth;
            const height = container.clientHeight;

            canvas.width = width;
            canvas.height = height;

            // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–∞–π–ª–∞
            const fieldWidth = FIELD_SIZE;
            const fieldHeight = FIELD_SIZE;
            const maxTileSize = Math.min(width / fieldWidth, height / fieldHeight);
            TILE_SIZE = Math.max(20, Math.min(60, maxTileSize));
        }

        function adaptUIForScreen() {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const isPortrait = screenHeight > screenWidth;

            // –î–ª—è –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —É–º–µ–Ω—å—à–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            if(isPortrait) {
                document.getElementById('spellsContainer').style.top = '20vh';
                document.getElementById('spellsContainer').style.height = '50vh';
            } else {
                document.getElementById('spellsContainer').style.top = '15vh';
                document.getElementById('spellsContainer').style.height = '60vh';
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –Ω–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö
            const controlsHint = document.getElementById('controlsHint');
            if(screenHeight < 500) {
                controlsHint.style.display = 'none';
            } else {
                controlsHint.style.display = 'block';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
        function initUI() {
            // –°–æ–∑–¥–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π
            const spellsContainer = document.getElementById('spellsContainer');
            spellsContainer.innerHTML = '';

            for(let i = 0; i < 8; i++) {
                const slot = document.createElement('div');
                slot.className = 'spell-slot empty';
                slot.dataset.index = i;
                slot.innerHTML = '+';
                spellsContainer.appendChild(slot);
            }

            setupEventListeners();
        }

        function setupEventListeners() {
            // –î–∂–æ—Å—Ç–∏–∫
            const joystickButtons = ['btnUp', 'btnLeft', 'btnDown', 'btnRight'];
            joystickButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);

                // Touch events
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const dir = getDirectionFromBtn(btnId);
                    socket.emit('move', dir);
                    btn.style.transform = 'scale(0.95)';
                });

                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    btn.style.transform = 'scale(1)';
                });

                // Mouse events
                btn.addEventListener('mousedown', () => {
                    const dir = getDirectionFromBtn(btnId);
                    socket.emit('move', dir);
                    btn.style.transform = 'scale(0.95)';
                });

                btn.addEventListener('mouseup', () => {
                    btn.style.transform = 'scale(1)';
                });
            });

            // –ö–Ω–æ–ø–∫–∞ CAST
            const castButton = document.getElementById('castButton');
            castButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                socket.emit('castSpell');
                castButton.style.transform = 'scale(0.95)';
            });

            castButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                castButton.style.transform = 'scale(1)';
            });

            castButton.addEventListener('mousedown', () => {
                socket.emit('castSpell');
                castButton.style.transform = 'scale(0.95)';
            });

            castButton.addEventListener('mouseup', () => {
                castButton.style.transform = 'scale(1)';
            });

            // –°–ª–æ—Ç—ã –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π
            document.querySelectorAll('.spell-slot').forEach(slot => {
                const index = parseInt(slot.dataset.index);

                slot.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    clearTimeout(longPressTimer);
                    longPressTimer = setTimeout(() => {
                        openSpellConfig(index);
                    }, 800);
                });

                slot.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    clearTimeout(longPressTimer);
                    if(!longPressTimer) return;
                    const player = players[myId];
                    if(player && player.spells[index]) {
                        socket.emit('selectSpell', index);
                    } else {
                        openSpellConfig(index);
                    }
                });

                slot.addEventListener('mousedown', () => {
                    clearTimeout(longPressTimer);
                    longPressTimer = setTimeout(() => {
                        openSpellConfig(index);
                    }, 800);
                });

                slot.addEventListener('mouseup', () => {
                    clearTimeout(longPressTimer);
                    if(!longPressTimer) return;
                    const player = players[myId];
                    if(player && player.spells[index]) {
                        socket.emit('selectSpell', index);
                    } else {
                        openSpellConfig(index);
                    }
                });
            });

            // –°–ª–∞–π–¥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è
            configSlider.addEventListener('input', () => {
                const value = parseInt(configSlider.value);
                configSpeed.textContent = value;
                configPower.textContent = 11 - value;
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', updateUISizes);
            window.addEventListener('orientationchange', () => {
                setTimeout(updateUISizes, 100);
            });
        }

        function getDirectionFromBtn(btnId) {
            switch(btnId) {
                case 'btnUp': return 'up';
                case 'btnDown': return 'down';
                case 'btnLeft': return 'left';
                case 'btnRight': return 'right';
                default: return 'down';
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è–º–∏
        function openSpellConfig(index) {
            currentConfigIndex = index;
            const player = players[myId];
            const spell = player ? player.spells[index] : null;

            if(spell) {
                spellTypeDisplay.textContent = spell.type === 'water' ? 'üíß Water Blast' : 'üõ°Ô∏è Shield';
                configSlider.value = spell.speed;
            } else {
                spellTypeDisplay.textContent = 'Select Spell Type';
                configSlider.value = 5;
            }

            configSlider.dispatchEvent(new Event('input'));
            spellConfig.style.display = 'block';
        }

        function closeSpellConfig() {
            spellConfig.style.display = 'none';
            currentConfigIndex = -1;
        }

        function saveSpellConfig() {
            if(currentConfigIndex === -1) return;

            const type = prompt('Enter spell type (water/shield):', 'water');
            if(type !== 'water' && type !== 'shield') {
                alert('Invalid spell type! Use "water" or "shield"');
                return;
            }

            const speed = parseInt(configSlider.value);
            const power = 11 - speed;

            socket.emit('updateSpell', {
                index: currentConfigIndex,
                type: type,
                speed: speed,
                power: power,
                selected: true
            });

            closeSpellConfig();
        }

        function deleteSpellConfig() {
            if(currentConfigIndex === -1) return;

            socket.emit('updateSpell', {
                index: currentConfigIndex,
                type: null,
                speed: 0,
                power: 0,
                selected: false
            });

            closeSpellConfig();
        }

        function updateSpellSlots() {
            const player = players[myId];
            if(!player) return;

            document.querySelectorAll('.spell-slot').forEach((slot, index) => {
                const spell = player.spells[index];

                slot.classList.remove('empty', 'selected');
                slot.innerHTML = '';

                if(spell) {
                    if(spell.selected) slot.classList.add('selected');

                    const icon = document.createElement('div');
                    icon.className = 'spell-icon';
                    icon.textContent = spell.type === 'water' ? 'üíß' : 'üõ°Ô∏è';

                    const stats = document.createElement('div');
                    stats.className = 'spell-stats';
                    stats.textContent = `${spell.speed}/${spell.power}`;

                    slot.appendChild(icon);
                    slot.appendChild(stats);
                } else {
                    slot.classList.add('empty');
                    slot.textContent = '+';
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        function handleKeyDown(e) {
            if(!myId) return;

            // WASD –∏ —Å—Ç—Ä–µ–ª–∫–∏
            if(e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                socket.emit('move', 'up');
                highlightButton('btnUp');
            }
            if(e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                socket.emit('move', 'down');
                highlightButton('btnDown');
            }
            if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                socket.emit('move', 'left');
                highlightButton('btnLeft');
            }
            if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                socket.emit('move', 'right');
                highlightButton('btnRight');
            }

            // Space –¥–ª—è –∫–∞—Å—Ç–∞
            if(e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                socket.emit('castSpell');
                const castButton = document.getElementById('castButton');
                castButton.style.transform = 'scale(0.95)';
            }

            // –¶–∏—Ñ—Ä—ã 1-8 –¥–ª—è –≤—ã–±–æ—Ä–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π
            if(e.key >= '1' && e.key <= '8') {
                const index = parseInt(e.key) - 1;
                if(players[myId] && players[myId].spells[index]) {
                    socket.emit('selectSpell', index);
                    highlightSpellSlot(index);
                }
            }

            // Enter –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
            if(e.key === 'Enter' && document.activeElement === nicknameInput) {
                rename();
            }

            // Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if(e.key === 'Escape' && spellConfig.style.display === 'block') {
                closeSpellConfig();
            }
        }

        function handleKeyUp(e) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–Ω–æ–ø–æ–∫
            if(e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                document.getElementById('btnUp').style.transform = 'scale(1)';
            }
            if(e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                document.getElementById('btnDown').style.transform = 'scale(1)';
            }
            if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                document.getElementById('btnLeft').style.transform = 'scale(1)';
            }
            if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                document.getElementById('btnRight').style.transform = 'scale(1)';
            }

            if(e.key === ' ' || e.key === 'Spacebar') {
                document.getElementById('castButton').style.transform = 'scale(1)';
            }
        }

        function highlightButton(btnId) {
            const btn = document.getElementById(btnId);
            if(!btn) return;

            btn.style.transform = 'scale(0.95)';
        }

        function highlightSpellSlot(index) {
            const slots = document.querySelectorAll('.spell-slot');
            if(slots[index]) {
                slots[index].classList.add('selected');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã
        function rename() {
            const newNickname = nicknameInput.value.trim();
            if(newNickname.length > 0) {
                socket.emit('rename', newNickname);
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
        function drawField() {
            if(!field || field.length === 0) return;

            const offsetX = (canvas.width - FIELD_SIZE * TILE_SIZE) / 2;
            const offsetY = (canvas.height - FIELD_SIZE * TILE_SIZE) / 2;

            for(let x = 0; x < FIELD_SIZE; x++) {
                for(let y = 0; y < FIELD_SIZE; y++) {
                    const tile = field[x][y];
                    const screenX = offsetX + x * TILE_SIZE;
                    const screenY = offsetY + y * TILE_SIZE;

                    if(tile === 1) {
                        ctx.fillStyle = '#222';
                        ctx.fillRect(screenX, screenY, TILE_SIZE, TILE_SIZE);
                    } else if(tile === 2) {
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(screenX, screenY, TILE_SIZE, TILE_SIZE);
                        ctx.fillStyle = '#A0522D';
                        ctx.fillRect(screenX + 3, screenY + 3, TILE_SIZE - 6, TILE_SIZE - 6);
                    } else {
                        ctx.fillStyle = '#2E8B57';
                        ctx.fillRect(screenX, screenY, TILE_SIZE, TILE_SIZE);
                        ctx.fillStyle = '#3CB371';
                        ctx.fillRect(screenX + 1, screenY + 1, TILE_SIZE - 2, TILE_SIZE - 2);
                    }

                    ctx.strokeStyle = '#1E5631';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(screenX, screenY, TILE_SIZE, TILE_SIZE);
                }
            }
        }

        function drawPlayers() {
            const offsetX = (canvas.width - FIELD_SIZE * TILE_SIZE) / 2;
            const offsetY = (canvas.height - FIELD_SIZE * TILE_SIZE) / 2;

            Object.values(players).forEach(player => {
                if(!player.x || !player.y) return;

                const screenX = offsetX + player.x * TILE_SIZE;
                const screenY = offsetY + player.y * TILE_SIZE;

                // Draw player
                ctx.fillStyle = player.color;
                ctx.fillRect(screenX + 4, screenY + 4, TILE_SIZE - 8, TILE_SIZE - 8);

                // Draw direction indicator
                ctx.fillStyle = 'white';
                if(player.direction === 'up') {
                    ctx.fillRect(screenX + TILE_SIZE / 2 - 2, screenY + 4, 4, 8);
                } else if(player.direction === 'down') {
                    ctx.fillRect(screenX + TILE_SIZE / 2 - 2, screenY + TILE_SIZE - 12, 4, 8);
                } else if(player.direction === 'left') {
                    ctx.fillRect(screenX + 4, screenY + TILE_SIZE / 2 - 2, 8, 4);
                } else if(player.direction === 'right') {
                    ctx.fillRect(screenX + TILE_SIZE - 12, screenY + TILE_SIZE / 2 - 2, 8, 4);
                }

                // Draw nickname
                ctx.fillStyle = 'white';
                ctx.font = `${Math.max(10, TILE_SIZE / 4)}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(player.nickname, screenX + TILE_SIZE / 2, screenY - 5);

                // Draw selection for current player
                if(player.id === myId) {
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(screenX + 2, screenY + 2, TILE_SIZE - 4, TILE_SIZE - 4);
                }
            });
        }

        function drawSpells() {
            const offsetX = (canvas.width - FIELD_SIZE * TILE_SIZE) / 2;
            const offsetY = (canvas.height - FIELD_SIZE * TILE_SIZE) / 2;

            spells.forEach(spell => {
                const startX = offsetX + spell.x * TILE_SIZE + TILE_SIZE / 2;
                const startY = offsetY + spell.y * TILE_SIZE + TILE_SIZE / 2;
                const endX = offsetX + spell.targetX * TILE_SIZE + TILE_SIZE / 2;
                const endY = offsetY + spell.targetY * TILE_SIZE + TILE_SIZE / 2;

                const currentX = startX + (endX - startX) * spell.progress;
                const currentY = startY + (endY - startY) * spell.progress;

                ctx.fillStyle = spell.type === 'water' ? '#40C4FF' : '#FFD740';
                ctx.beginPath();
                ctx.arc(currentX, currentY, TILE_SIZE / 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawField();
            drawPlayers();
            drawSpells();
            requestAnimationFrame(render);
        }

        // Socket events
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('init', (data) => {
            console.log('Game initialized');
            myId = data.id;
            field = data.field || [];
            FIELD_SIZE = data.fieldSize || 15;
            players = data.allPlayers || {};
            spells = data.allSpells || [];

            // Update UI
            nicknameDisplay.textContent = data.nickname;
            nicknameInput.value = data.nickname;
            scoreDisplay.textContent = players[myId]?.score || 0;
            hpDisplay.textContent = players[myId]?.hp || 100;

            // Hide loading screen
            loadingScreen.style.display = 'none';
            gameContainer.style.display = 'block';

            // Initialize UI
            updateUISizes();
            updateSpellSlots();

            // Start game
            render();
        });

        socket.on('playerJoined', (player) => {
            players[player.id] = player;
        });

        socket.on('playerMoved', (data) => {
            if(players[data.id]) {
                players[data.id].x = data.x;
                players[data.id].y = data.y;
                players[data.id].direction = data.direction;
            }
        });

        socket.on('playerUpdated', (player) => {
            players[player.id] = player;
            if(player.id === myId) {
                nicknameDisplay.textContent = player.nickname;
                scoreDisplay.textContent = player.score;
                hpDisplay.textContent = player.hp;
                updateSpellSlots();
            }
        });

        socket.on('spellCast', (spell) => {
            spells.push(spell);
        });

        socket.on('spellsUpdate', (updatedSpells) => {
            spells = updatedSpells;
        });

        socket.on('blockDestroyed', (data) => {
            if(field[data.x] && field[data.x][data.y] === 2) {
                field[data.x][data.y] = 0;
            }
        });

        socket.on('playerLeft', (playerId) => {
            delete players[playerId];
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            loadingScreen.innerHTML = '<div>Connection error. Please refresh.</div>';
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
            initUI();

            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤
            updateUISizes();

            // –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ä–∞–∑—É
            render();
        });
    </script>
</body>

</html>