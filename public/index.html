<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞–≥–∏—á–µ—Å–∫–∏–π Bomberman</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a2a 0%, #1a1a40 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        #top-panel {
            background: rgba(20, 20, 60, 0.95);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ffd700;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 100;
            flex-shrink: 0;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nickname {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nickname:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .nickname-input {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            font-size: 18px;
            padding: 5px;
            border-radius: 5px;
            width: 150px;
        }

        .health,
        .shield,
        .score {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 16px;
        }

        .health span,
        .shield span,
        .score span {
            margin-left: 5px;
        }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        #game-field {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #1a1a4a;
        }

        #game-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #bottom-panel {
            background: rgba(20, 20, 60, 0.95);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-top: 2px solid #ffd700;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 100;
            flex-shrink: 0;
        }

        /* –î–∂–æ—Å—Ç–∏–∫ */
        #joystick-container {
            position: relative;
            width: 120px;
            height: 120px;
        }

        #joystick {
            width: 100%;
            height: 100%;
            background: rgba(40, 40, 80, 0.8);
            border: 3px solid #ffd700;
            border-radius: 50%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            padding: 10px;
        }

        .joystick-btn {
            background: rgba(60, 60, 100, 0.9);
            border: 2px solid #ffd700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: #ffd700;
            cursor: pointer;
            transition: all 0.1s;
        }

        .joystick-btn:active {
            background: rgba(255, 215, 0, 0.3);
            transform: scale(0.95);
        }

        .joystick-btn.center {
            background: transparent;
            border: none;
        }

        /* –ü–∞–Ω–µ–ª—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π */
        #spells-panel {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
            margin-right: 10px;
        }

        .spell-slot {
            width: 60px;
            height: 60px;
            background: rgba(40, 40, 80, 0.8);
            border: 2px solid #555;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .spell-slot:hover {
            border-color: #888;
        }

        .spell-slot.selected {
            border: 3px solid #ffd700;
            transform: scale(1.05);
        }

        .spell-slot.empty {
            background: rgba(60, 60, 60, 0.6);
            font-size: 24px;
            color: #888;
        }

        .spell-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .spell-stats {
            font-size: 12px;
            color: #aaa;
        }

        .spell-index {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #ffd700;
        }

        /* –ö–Ω–æ–ø–∫–∞ CAST */
        #cast-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #cast-button {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 30% 30%, #ff4444, #cc0000);
            border: 4px solid #ffd700;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }

        #cast-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.6);
        }

        #cast-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cast-hint {
            font-size: 12px;
            color: #aaa;
            text-align: center;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a40 0%, #0a0a2a 100%);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            min-width: 300px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }

        .modal h2 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        .spell-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: rgba(40, 40, 80, 0.6);
            border: 2px solid #555;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .spell-option:hover {
            border-color: #ffd700;
            background: rgba(60, 60, 100, 0.8);
        }

        .spell-option-icon {
            font-size: 24px;
        }

        .spell-option-name {
            font-size: 16px;
            font-weight: bold;
        }

        .spell-option-desc {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }

        /* –û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è */
        .slider-container {
            margin: 20px 0;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .slider {
            width: 100%;
            height: 30px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #00aaff, #ffaa00);
            border-radius: 15px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .slider-value {
            text-align: center;
            font-size: 18px;
            margin: 10px 0;
            color: #ffd700;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-save {
            background: linear-gradient(to bottom, #00cc00, #009900);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(to bottom, #ff4444, #cc0000);
            color: white;
        }

        .btn-cancel {
            background: linear-gradient(to bottom, #666, #444);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes casting {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .casting-ring {
            position: absolute;
            width: 70px;
            height: 70px;
            border: 5px solid transparent;
            border-top-color: #00ffff;
            border-radius: 50%;
            animation: casting 1s linear infinite;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .player-info {
                flex-wrap: wrap;
                gap: 10px;
            }

            #joystick-container {
                width: 100px;
                height: 100px;
            }

            .spell-slot {
                width: 50px;
                height: 50px;
            }

            .spell-icon {
                font-size: 16px;
            }

            .spell-stats {
                font-size: 10px;
            }

            #cast-button {
                width: 70px;
                height: 70px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            #top-panel {
                padding: 5px 10px;
            }

            #bottom-panel {
                padding: 10px;
            }

            .nickname {
                font-size: 14px;
            }

            .health,
            .shield,
            .score {
                font-size: 12px;
            }

            #joystick-container {
                width: 80px;
                height: 80px;
            }

            .joystick-btn {
                font-size: 12px;
            }

            .spell-slot {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>

<body>
    <div id="game-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div id="top-panel">
            <div class="player-info">
                <div id="nickname-display" class="nickname">–ò–≥—Ä–æ–∫</div>
                <div class="health">‚ù§Ô∏è <span id="health">10/10</span></div>
                <div class="shield">üõ°Ô∏è <span id="shield">0</span></div>
                <div class="score">üèÜ <span id="score">0</span></div>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
        <div id="game-field">
            <canvas id="game-canvas"></canvas>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="bottom-panel">
            <!-- –î–∂–æ—Å—Ç–∏–∫ -->
            <div id="joystick-container">
                <div id="joystick">
                    <div class="joystick-btn center"></div>
                    <div class="joystick-btn up" data-direction="up">‚Üë</div>
                    <div class="joystick-btn center"></div>
                    <div class="joystick-btn left" data-direction="left">‚Üê</div>
                    <div class="joystick-btn center"></div>
                    <div class="joystick-btn right" data-direction="right">‚Üí</div>
                    <div class="joystick-btn center"></div>
                    <div class="joystick-btn down" data-direction="down">‚Üì</div>
                    <div class="joystick-btn center"></div>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π -->
            <div id="spells-panel">
                <!-- –°–ª–æ—Ç—ã –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ CAST -->
            <div id="cast-container">
                <button id="cast-button">CAST</button>
                <div class="cast-hint">SPACE</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è -->
    <div id="spell-select-modal" class="modal">
        <div class="modal-content">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ</h2>
            <div class="spell-option" data-type="water">
                <div class="spell-option-icon">üíß</div>
                <div>
                    <div class="spell-option-name">–í–æ–¥—è–Ω–æ–π –≤—ã—Å—Ç—Ä–µ–ª</div>
                    <div class="spell-option-desc">–ù–∞–Ω–æ—Å–∏—Ç —É—Ä–æ–Ω –ø–æ –ø—Ä—è–º–æ–π. –£—Ä–æ–Ω —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º.</div>
                </div>
            </div>
            <div class="spell-option" data-type="shield">
                <div class="spell-option-icon">üõ°Ô∏è</div>
                <div>
                    <div class="spell-option-name">–©–∏—Ç</div>
                    <div class="spell-option-desc">–î–æ–±–∞–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ HP. –¶–µ–ª—å –≤—Å–µ–≥–¥–∞ - —Å–∞–º –∏–≥—Ä–æ–∫.</div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-cancel" id="cancel-spell-select">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è -->
    <div id="spell-config-modal" class="modal">
        <div class="modal-content">
            <h2 id="config-spell-name">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è</h2>
            <div class="slider-container">
                <div class="slider-labels">
                    <span>‚ö° –ë—ã—Å—Ç—Ä–æ</span>
                    <span>üí™ –°–∏–ª—å–Ω–æ</span>
                </div>
                <input type="range" min="1" max="10" value="6" class="slider" id="spell-slider">
                <div class="slider-value">
                    –°–∫–æ—Ä–æ—Å—Ç—å: <span id="speed-value">6</span> / –°–∏–ª–∞: <span id="power-value">5</span>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-save" id="save-spell">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-delete" id="delete-spell">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-cancel" id="cancel-spell-config">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const CONFIG = {
            FIELD_SIZE: 21,
            CELL_SIZE: 40,
            SPELL_SPEED: 300
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket;
        let canvas, ctx;
        let camera = { x: 0, y: 0, zoom: 1 };
        let currentPlayer = null;
        let players = new Map();
        let spells = new Map();
        let blocks = new Map();
        let selectedSpellIndex = 0;
        let currentSpellSlot = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Canvas
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();

            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
            socket = io();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Å–µ—Ä–≤–µ—Ä–∞
            socket.on('init', handleInit);
            socket.on('player_joined', handlePlayerJoined);
            socket.on('player_left', handlePlayerLeft);
            socket.on('player_moved', handlePlayerMoved);
            socket.on('player_updated', handlePlayerUpdated);
            socket.on('player_hit', handlePlayerHit);
            socket.on('player_died', handlePlayerDied);
            socket.on('player_respawned', handlePlayerRespawned);
            socket.on('casting_started', handleCastingStarted);
            socket.on('casting_progress', handleCastingProgress);
            socket.on('spell_cast', handleSpellCast);
            socket.on('spell_moved', handleSpellMoved);
            socket.on('spell_hit', handleSpellHit);
            socket.on('spell_disappeared', handleSpellDisappeared);
            socket.on('block_added', handleBlockAdded);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
            initUI();

            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
            requestAnimationFrame(gameLoop);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
        function initUI() {
            // –î–∂–æ—Å—Ç–∏–∫
            document.querySelectorAll('.joystick-btn').forEach(btn => {
                if(btn.dataset.direction) {
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        socket.emit('move', { direction: btn.dataset.direction });
                    });

                    btn.addEventListener('mousedown', () => {
                        socket.emit('move', { direction: btn.dataset.direction });
                    });
                }
            });

            // –ö–Ω–æ–ø–∫–∞ CAST
            const castButton = document.getElementById('cast-button');
            castButton.addEventListener('click', () => {
                if(!currentPlayer || currentPlayer.isCasting) return;
                socket.emit('cast_spell', { spellIndex: selectedSpellIndex });
            });

            // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            document.addEventListener('keydown', handleKeyDown);

            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∏–∫–Ω–µ–π–º–∞
            const nicknameDisplay = document.getElementById('nickname-display');
            nicknameDisplay.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'nickname-input';
                input.value = currentPlayer.nickname;
                input.maxLength = 15;

                input.addEventListener('blur', () => {
                    updateNickname(input.value);
                    nicknameDisplay.style.display = 'block';
                });

                input.addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') {
                        updateNickname(input.value);
                        nicknameDisplay.style.display = 'block';
                    }
                });

                nicknameDisplay.style.display = 'none';
                nicknameDisplay.parentNode.insertBefore(input, nicknameDisplay.nextSibling);
                input.focus();
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
        function handleKeyDown(e) {
            if(!currentPlayer) return;

            switch(e.key.toLowerCase()) {
                case 'w':
                case '—Ü':
                case 'arrowup':
                    socket.emit('move', { direction: 'up' });
                    break;
                case 's':
                case '—ã':
                case 'arrowdown':
                    socket.emit('move', { direction: 'down' });
                    break;
                case 'a':
                case '—Ñ':
                case 'arrowleft':
                    socket.emit('move', { direction: 'left' });
                    break;
                case 'd':
                case '–≤':
                case 'arrowright':
                    socket.emit('move', { direction: 'right' });
                    break;
                case ' ':
                    if(!currentPlayer.isCasting) {
                        socket.emit('cast_spell', { spellIndex: selectedSpellIndex });
                    }
                    break;
                case '1': case '2': case '3': case '4':
                case '5': case '6': case '7': case '8':
                    const index = parseInt(e.key) - 1;
                    if(currentPlayer.spells[index] !== undefined) {
                        selectSpell(index);
                    }
                    break;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        function handleInit(data) {
            currentPlayer = data.player;
            updatePlayerUI();
            createSpellSlots();

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
            data.gameState.players.forEach(p => {
                if(p.id !== socket.id) {
                    players.set(p.id, p);
                }
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –±–ª–æ–∫–æ–≤
            data.gameState.blocks.forEach(([key, block]) => {
                blocks.set(key, block);
            });
        }

        function handlePlayerJoined(player) {
            players.set(player.id, player);
        }

        function handlePlayerLeft(data) {
            players.delete(data.id);
        }

        function handlePlayerMoved(data) {
            const player = players.get(data.id) || (data.id === socket.id ? currentPlayer : null);
            if(player) {
                player.x = data.x;
                player.y = data.y;
                player.direction = data.direction;
            }
        }

        function handlePlayerUpdated(data) {
            if(data.id === socket.id) {
                Object.assign(currentPlayer, data);
                updatePlayerUI();

                if(data.spells) {
                    createSpellSlots();
                }
                if(data.selectedSpell !== undefined) {
                    selectSpell(data.selectedSpell);
                }
            } else {
                const player = players.get(data.id);
                if(player) {
                    Object.assign(player, data);
                }
            }
        }

        function handlePlayerHit(data) {
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ–ø–∞–¥–∞–Ω–∏—è
            if(data.targetId === socket.id) {
                // –ú–∏–≥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
                document.body.style.backgroundColor = '#ff4444';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 100);
            }
        }

        function handlePlayerDied(data) {
            // –≠—Ñ—Ñ–µ–∫—Ç —Å–º–µ—Ä—Ç–∏
            const player = players.get(data.playerId);
            if(player) {
                player.hp = 0;
            }
        }

        function handlePlayerRespawned(data) {
            const player = data.id === socket.id ? currentPlayer : players.get(data.id);
            if(player) {
                Object.assign(player, data);
            }
        }

        function handleCastingStarted(data) {
            const player = data.playerId === socket.id ? currentPlayer : players.get(data.playerId);
            if(player) {
                player.isCasting = true;
                player.castProgress = 0;
            }
        }

        function handleCastingProgress(data) {
            const player = data.playerId === socket.id ? currentPlayer : players.get(data.playerId);
            if(player) {
                player.castProgress = data.progress;
            }
        }

        function handleSpellCast(data) {
            spells.set(data.spell.id, data.spell);

            const player = data.playerId === socket.id ? currentPlayer : players.get(data.playerId);
            if(player) {
                player.isCasting = false;
            }
        }

        function handleSpellMoved(data) {
            const spell = spells.get(data.spellId);
            if(spell) {
                spell.x = data.x;
                spell.y = data.y;
            }
        }

        function handleSpellHit(data) {
            spells.delete(data.spellId);

            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ–ø–∞–¥–∞–Ω–∏—è
            if(data.target === 'block') {
                // –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è –±–ª–æ–∫–∞
                // (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —á–∞—Å—Ç–∏—Ü—ã)
            }
        }

        function handleSpellDisappeared(data) {
            spells.delete(data.spellId);
        }

        function handleBlockAdded(data) {
            blocks.set(`${data.x},${data.y}`, data.block);
        }

        // UI —Ñ—É–Ω–∫—Ü–∏–∏
        function updatePlayerUI() {
            if(!currentPlayer) return;

            document.getElementById('nickname-display').textContent = currentPlayer.nickname;
            document.getElementById('health').textContent = `${currentPlayer.hp}/${currentPlayer.maxHp}`;
            document.getElementById('shield').textContent = currentPlayer.shield;
            document.getElementById('score').textContent = currentPlayer.score;

            const castButton = document.getElementById('cast-button');
            castButton.disabled = currentPlayer.isCasting || currentPlayer.hp <= 0;
        }

        function createSpellSlots() {
            if(!currentPlayer) return;

            const spellsPanel = document.getElementById('spells-panel');
            spellsPanel.innerHTML = '';

            currentPlayer.spells.forEach((spell, index) => {
                const slot = document.createElement('div');
                slot.className = 'spell-slot';
                slot.dataset.index = index;

                if(spell) {
                    slot.innerHTML = `
                        <div class="spell-index">${index + 1}</div>
                        <div class="spell-icon">${spell.type === 'water' ? 'üíß' : 'üõ°Ô∏è'}</div>
                        <div class="spell-stats">${spell.speed}/${spell.power}</div>
                    `;

                    if(index === selectedSpellIndex) {
                        slot.classList.add('selected');
                    }

                    slot.addEventListener('click', () => selectSpell(index));
                } else {
                    slot.className += ' empty';
                    slot.textContent = '+';

                    slot.addEventListener('click', () => openSpellSelect(index));
                }

                spellsPanel.appendChild(slot);
            });
        }

        function selectSpell(index) {
            if(!currentPlayer || !currentPlayer.spells[index]) return;

            selectedSpellIndex = index;
            currentPlayer.selectedSpell = index;

            // –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            document.querySelectorAll('.spell-slot').forEach((slot, i) => {
                slot.classList.toggle('selected', i === index);
            });

            socket.emit('select_spell', { spellIndex: index });
        }

        function openSpellSelect(slotIndex) {
            currentSpellSlot = slotIndex;

            const modal = document.getElementById('spell-select-modal');
            modal.classList.add('active');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è
            document.querySelectorAll('.spell-option').forEach(option => {
                option.onclick = () => {
                    modal.classList.remove('active');
                    openSpellConfig(slotIndex, option.dataset.type);
                };
            });

            document.getElementById('cancel-spell-select').onclick = () => {
                modal.classList.remove('active');
                currentSpellSlot = null;
            };
        }

        function openSpellConfig(slotIndex, spellType) {
            const modal = document.getElementById('spell-config-modal');
            modal.classList.add('active');

            const slider = document.getElementById('spell-slider');
            const speedValue = document.getElementById('speed-value');
            const powerValue = document.getElementById('power-value');

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–∞
            slider.oninput = function () {
                const speed = parseInt(this.value);
                const power = 11 - speed; // –û–±—Ä–∞—Ç–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
                speedValue.textContent = speed;
                powerValue.textContent = power;
            };

            // –°–±—Ä–æ—Å –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            slider.value = 6;
            slider.oninput();

            // –ö–Ω–æ–ø–∫–∏
            document.getElementById('save-spell').onclick = () => {
                const speed = parseInt(slider.value);
                const power = 11 - speed;

                socket.emit('update_spell', {
                    spellIndex: slotIndex,
                    type: spellType,
                    speed: speed,
                    power: power
                });

                modal.classList.remove('active');
                currentSpellSlot = null;
            };

            document.getElementById('delete-spell').onclick = () => {
                socket.emit('remove_spell', { spellIndex: slotIndex });
                modal.classList.remove('active');
                currentSpellSlot = null;
            };

            document.getElementById('cancel-spell-config').onclick = () => {
                modal.classList.remove('active');
                currentSpellSlot = null;
            };
        }

        function updateNickname(nickname) {
            if(nickname.trim().length > 0) {
                socket.emit('update_nickname', { nickname: nickname.trim() });
            }
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            updateCamera();
            render();
            requestAnimationFrame(gameLoop);
        }

        function updateCamera() {
            if(!currentPlayer) return;

            // –ü–ª–∞–≤–Ω–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã –∑–∞ –∏–≥—Ä–æ–∫–æ–º
            const targetX = currentPlayer.x * CONFIG.CELL_SIZE;
            const targetY = currentPlayer.y * CONFIG.CELL_SIZE;

            camera.x += (targetX - camera.x) * 0.1;
            camera.y += (targetY - camera.y) * 0.1;

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            camera.x = canvas.width / 2 - camera.x;
            camera.y = canvas.height / 2 - camera.y;
        }

        function render() {
            // –û—á–∏—Å—Ç–∫–∞ canvas
            ctx.fillStyle = '#1a1a4a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π –∫–∞–º–µ—Ä—ã
            ctx.save();
            ctx.translate(camera.x, camera.y);

            // –†–µ–Ω–¥–µ—Ä –±–ª–æ–∫–æ–≤
            renderBlocks();

            // –†–µ–Ω–¥–µ—Ä –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π
            renderSpells();

            // –†–µ–Ω–¥–µ—Ä –∏–≥—Ä–æ–∫–æ–≤
            renderPlayers();

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            ctx.restore();

            // –†–µ–Ω–¥–µ—Ä UI –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
            renderUI();
        }

        function renderBlocks() {
            blocks.forEach((block, key) => {
                const [x, y] = key.split(',').map(Number);

                ctx.fillStyle = block.type === 'wall' ? '#333366' :
                    block.durability >= 4 ? '#8B4513' :
                        block.durability >= 2 ? '#A0522D' : '#D2691E';

                ctx.fillRect(
                    x * CONFIG.CELL_SIZE,
                    y * CONFIG.CELL_SIZE,
                    CONFIG.CELL_SIZE,
                    CONFIG.CELL_SIZE
                );

                // –ö–æ–Ω—Ç—É—Ä –±–ª–æ–∫–∞
                ctx.strokeStyle = '#222244';
                ctx.lineWidth = 2;
                ctx.strokeRect(
                    x * CONFIG.CELL_SIZE,
                    y * CONFIG.CELL_SIZE,
                    CONFIG.CELL_SIZE,
                    CONFIG.CELL_SIZE
                );

                // –ü—Ä–æ—á–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä—É—à–∞–µ–º—ã—Ö –±–ª–æ–∫–æ–≤
                if(block.type === 'destructible') {
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(
                        block.durability,
                        x * CONFIG.CELL_SIZE + CONFIG.CELL_SIZE / 2,
                        y * CONFIG.CELL_SIZE + CONFIG.CELL_SIZE / 2 + 4
                    );
                }
            });
        }

        function renderSpells() {
            spells.forEach(spell => {
                ctx.fillStyle = spell.type === 'water' ? '#00aaff' : '#ffd700';

                ctx.beginPath();
                ctx.arc(
                    spell.x * CONFIG.CELL_SIZE,
                    spell.y * CONFIG.CELL_SIZE,
                    8, 0, Math.PI * 2
                );
                ctx.fill();

                // –•–≤–æ—Å—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è
                ctx.strokeStyle = spell.type === 'water' ? '#0088cc' : '#ffaa00';
                ctx.lineWidth = 3;
                ctx.beginPath();

                let tailX = spell.x;
                let tailY = spell.y;
                switch(spell.direction) {
                    case 'up': tailY += 0.3; break;
                    case 'down': tailY -= 0.3; break;
                    case 'left': tailX += 0.3; break;
                    case 'right': tailX -= 0.3; break;
                }

                ctx.moveTo(
                    spell.x * CONFIG.CELL_SIZE,
                    spell.y * CONFIG.CELL_SIZE
                );
                ctx.lineTo(
                    tailX * CONFIG.CELL_SIZE,
                    tailY * CONFIG.CELL_SIZE
                );
                ctx.stroke();
            });
        }

        function renderPlayers() {
            // –†–µ–Ω–¥–µ—Ä –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
            players.forEach(player => {
                if(player.hp > 0) {
                    renderPlayer(player);
                }
            });

            // –†–µ–Ω–¥–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö
            if(currentPlayer && currentPlayer.hp > 0) {
                renderPlayer(currentPlayer, true);
            }
        }

        function renderPlayer(player, isCurrent = false) {
            const x = player.x * CONFIG.CELL_SIZE;
            const y = player.y * CONFIG.CELL_SIZE;
            const size = CONFIG.CELL_SIZE * 0.8;

            // –¢–µ–ª–æ –∏–≥—Ä–æ–∫–∞
            ctx.fillStyle = player.color;
            ctx.fillRect(
                x - size / 2,
                y - size / 2,
                size,
                size
            );

            // –ö–æ–Ω—Ç—É—Ä
            ctx.strokeStyle = isCurrent ? '#ffd700' : '#ffffff';
            ctx.lineWidth = isCurrent ? 3 : 2;
            ctx.strokeRect(
                x - size / 2,
                y - size / 2,
                size,
                size
            );

            // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–∞
            ctx.fillStyle = '#000';
            let eyeX = x, eyeY = y;
            const eyeOffset = size * 0.25;

            switch(player.direction) {
                case 'up': eyeY -= eyeOffset; break;
                case 'down': eyeY += eyeOffset; break;
                case 'left': eyeX -= eyeOffset; break;
                case 'right': eyeX += eyeOffset; break;
            }

            ctx.beginPath();
            ctx.arc(eyeX, eyeY, size * 0.1, 0, Math.PI * 2);
            ctx.fill();

            // –ù–∏–∫–Ω–µ–π–º
            ctx.fillStyle = isCurrent ? '#ffd700' : '#ffffff';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(
                player.nickname,
                x,
                y - size
            );

            // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
            const healthWidth = size;
            const healthHeight = 5;
            const healthPercent = player.hp / player.maxHp;

            ctx.fillStyle = '#333';
            ctx.fillRect(
                x - healthWidth / 2,
                y + size / 2 + 5,
                healthWidth,
                healthHeight
            );

            ctx.fillStyle = healthPercent > 0.5 ? '#00ff00' :
                healthPercent > 0.2 ? '#ffff00' : '#ff0000';
            ctx.fillRect(
                x - healthWidth / 2,
                y + size / 2 + 5,
                healthWidth * healthPercent,
                healthHeight
            );

            // –©–∏—Ç
            if(player.shield > 0) {
                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y, size / 2 + 3, 0, Math.PI * 2);
                ctx.stroke();
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–∞—Å—Ç–∞
            if(player.isCasting) {
                const ringSize = size + 20;
                ctx.strokeStyle = `rgba(0, 255, 255, ${player.castProgress / 100})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(x, y, ringSize, 0, Math.PI * 2 * (player.castProgress / 100));
                ctx.stroke();
            }
        }

        function renderUI() {
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è
            if(currentPlayer && currentPlayer.spells[selectedSpellIndex]) {
                const spell = currentPlayer.spells[selectedSpellIndex];
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(10, canvas.height - 50, 150, 40);

                ctx.fillStyle = '#fff';
                ctx.font = '16px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(
                    `–í—ã–±—Ä–∞–Ω–æ: ${spell.name}`,
                    20,
                    canvas.height - 30
                );

                ctx.fillText(
                    `–°–∫–æ—Ä–æ—Å—Ç—å: ${spell.speed} | –°–∏–ª–∞: ${spell.power}`,
                    20,
                    canvas.height - 10
                );
            }
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight -
                document.getElementById('top-panel').offsetHeight -
                document.getElementById('bottom-panel').offsetHeight;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å–∞–π–∑–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', resizeCanvas);

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        window.onload = init;
    </script>
</body>

</html>